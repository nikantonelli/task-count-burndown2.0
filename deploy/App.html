<!DOCTYPE html>
<html>
<head>
    <title>task-count-burndown</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("TaskCountBurnDownChart",{extend:"Rally.app.TimeboxScopedApp",compooinentCls:"app",layout:"fit",autoScroll:!1,requires:["TaskCountCalculator"],config:{defaultSettings:{defaultScopeType:"Iteration"}},launch:function(){Deft.Chain.parallel([this._getTaskModel,this._getCurrentIteration,this._getCurrentRelease]).then({success:function(e){this.model=e[0],this._loadTasks().then({success:function(e){this._processTasks(e),this._addChart()},failure:function(e){console.log(e)},scope:this})},failure:function(e){console.log(e)},scope:this})},getSettingsFields:function(){return[{name:"fieldcontainer",width:800,fieldLabel:"Timebox Type",defaultType:"radiofield",defaults:{flex:1},layout:"hbox",items:[{boxLabel:"Iteration",name:"timeboxtype",inputValue:"Iteration",id:"radioIt"},{boxLabel:"Release",name:"timeboxtype",inputValue:"Release",id:"radioRl"}]}]},_getTaskModel:function(){return Rally.data.wsapi.ModelFactory.getModel({type:"task"})},_getCurrentIteration:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,filters:[{property:"StartDate",operator:"<=",value:Ext.Date.format(new Date,"Y-m-d\\T00:00:00")},{property:"EndDate",operator:">",value:Ext.Date.format(new Date,"Y-m-d\\T23:59:59")}],listeners:{load:function(t,a,r){r?(a.length&&(this.currentIteration=t.getAt(0)),e.resolve(this.currentIteration)):e.reject("No iteration")}},scope:this}),e.promise},_getCurrentRelease:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,filters:[{property:"ReleaseStartDate",operator:"<=",value:Ext.Date.format(new Date,"Y-m-d\\T00:00:00")},{property:"ReleaseDate",operator:">",value:Ext.Date.format(new Date,"Y-m-d\\T23:59:59")}],listeners:{load:function(t,a,r){r?(a.length&&(this.currentRelease=t.getAt(0)),e.resolve(this.currentRelease)):e.reject("No Release")}},scope:this}),e.promise},_loadTasks:function(){var e=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Task",autoLoad:!0,filters:this._getTaskFilters(),listeners:{load:function(t,a,r){r&&a.length?e.resolve(a):e.reject("No Tasks")}}}),e.promise},_getTaskFilters:function(){var e=this._getScope(),t=this.defaultScopeType,a=Ext.Date.subtract(new Date,Ext.Date.DAY,140),r=new Date;if(null===e){var o=this.getSetting("timeboxtype");o&&(t=o)}else"Milestone"===(t=e.type)?(Rally.ui.notify.Notifier.showWarning({message:"Milestone scoping not supported. Defaulting to"}),t=this.defaultScopeType):(a=e.record.data.StartDate,r=e.record.data.EndDate);return"Iteration"===t?[{property:"Iteration.StartDate",operator:">=",value:a},{property:"Iteration.EndDate",operator:"<=",value:r}]:[{property:"Release.ReleaseStartDate",operator:">=",value:a},{property:"Release.ReleaseDate",operator:"<=",value:r}]},_processTasks:function(e){this.taskList=_.pluck(e,function(e){return e.get("ObjectID")})},_addChart:function(){var e=this.getContext(),t=[this.model.typePath],a=[],r={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:e.getScopedStateId("filters"),filterChildren:!1,modelNames:t,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["Owner"],addQuickFilterConfig:{whiteListFields:a}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:a}}}}}}],context:e,modelNames:t,storeConfig:{filters:this._getFilters()}};this.add(r)},_getChartConfig:function(){return{xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:this._getStoreConfig(),calculatorType:"TaskCountCalculator",calculatorConfig:this._getCalculatorConfig(),chartConfig:this._getHCConfig()}},_getHCConfig:function(){return{chart:{type:"column"},title:{text:"Task Burndown",x:-20},plotOptions:{series:{marker:{radius:2}},column:{stacking:"normal",dataLabels:{enabled:!0,color:"white",style:{textShadow:"0 0 1px black"}}}},xAxis:{type:"datetime",labels:{formatter:function(){return Ext.Date.format(new Date(this.value),"d/m/Y")}}},yAxis:{title:{text:"Task Count"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{pointFormat:"{series.name}:<b>{point.y}</b><br/>",shared:!0,valueDecimals:0},legend:{align:"center",verticalAlign:"bottom"}}},_getStoreConfig:function(){return{find:{ObjectID:{$in:this.taskList||[]}},pageSize:2e3,limit:1/0,fetch:["FormattedID","ObjectID","State","Iteration","_TypeHierarchy","_ValidFrom","_ValidTo"],hydrate:["_TypeHierarchy","Iteration"]}},_getFilters:function(){var e=[],t=this.getContext().getTimeboxScope();return t&&e.push(t.getQueryFilter()),this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),e},_getScope:function(){return void 0!==this.getContext().getTimeboxScope()?this.getContext().getTimeboxScope():null},_getCalculatorConfig:function(){return{granularity:Ext.Date.DAY,holidays:[],workDays:"Monday,Tuesday,Wednesday,Thursday,Friday"}}});
                Ext.define("TaskCountCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{},constructor:function(e){return self=this,this.initConfig(e),this},prepareChartData:function(e){},getMetrics:function(){return[{as:"Total",field:"ObjectID",display:"line",f:"count"},{field:"ObjectID",as:"In-Progress",f:"filteredCount",filterField:"State",filterValues:["In-Progress"],display:"column"},{field:"ObjectID",as:"Defined",f:"filteredCount",filterField:"State",filterValues:["Defined"],display:"column"},{field:"ObjectID",as:"Completed",f:"filteredCount",filterField:"State",filterValues:["Completed"],display:"column"}]},getDerivedFieldsOnInput:function(){return[]},getDerivedFieldsAfterSummary:function(){return[{as:"Ideal",f:function(e,t,i,l){var n=_.max(_.pluck(l,"Total"));return 100*(n-t*(n/(l.length-1)))/100}}]},defined:function(e){return!_.isUndefined(e)&&!_.isNull(e)}});

            Rally.launchApp('TaskCountBurnDownChart', {
                name:"task-count-burndown",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
